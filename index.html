<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Sistem Akreditasi Blockchain</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
        }

        .login-card {
            max-width: 400px;
            margin: auto;
        }

        .form-control:focus,
        .form-select:focus {
            box-shadow: 0 0 0 0.25rem rgba(253, 126, 20, 0.25);
            border-color: #fd7e14;
        }

        .btn-sakti {
            background-color: #f97316;
            border-color: #f97316;
            color: white;
        }

        .btn-sakti:hover {
            background-color: #ea580c;
            border-color: #ea580c;
            color: white;
        }
    </style>
</head>

<body class="d-flex align-items-center py-4 bg-body-tertiary min-vh-100">

    <main class="w-100 m-auto">
        <div id="login-container">
            <div class="text-center mb-4">
                <svg class="mx-auto mb-2" width="64" height="64" viewBox="0 0 24 24" fill="none"
                    xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2L2 7V17L12 22L22 17V7L12 2Z" stroke="#212529" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" />
                    <path d="M2 7L12 12L22 7" stroke="#212529" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" />
                    <path d="M12 12V22" stroke="#212529" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" />
                    <path d="M17 4.5L7 9.5" stroke="#212529" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" />
                </svg>
                <h1 class="h3 mb-3 fw-bold">Login</h1>
            </div>

            <div class="login-card">
                <div class="card shadow-sm border-light">
                    <div class="card-body p-5">
                        <form id="loginForm">
                            <div class="mb-3">
                                <label for="loginUsername" class="form-label">Username</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-person"></i></span>
                                    <input type="text" class="form-control" id="loginUsername" name="username"
                                        placeholder="Masukkan Username" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="loginPassword" class="form-label">Kata Sandi</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-lock"></i></span>
                                    <input type="password" class="form-control" id="loginPassword" name="password"
                                        placeholder="Masukan Kata Sandi" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="loginRole" class="form-label">Masuk sebagai</label>
                                <select id="loginRole" name="role" class="form-select" required>
                                    <option value="UniversityAdmin">UPPS</option>
                                    <option value="Assessor">Asesor</option>
                                    <option value="SuperAdmin">Admin</option>
                                </select>
                            </div>
                            <div class="text-end mb-4">
                                <a href="#" class="text-decoration-none small">Lupa kata sandi?</a>
                            </div>
                            <button type="submit" id="loginBtn" class="btn btn-sakti w-100 py-2">
                                <span id="loginBtnText">
                                    <i class="bi bi-box-arrow-in-right me-2"></i>Masuk
                                </span>
                                <div id="loginLoader" class="spinner-border spinner-border-sm d-none" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </button>
                        </form>
                        <div id="loginResult" class="alert alert-danger d-flex align-items-center mt-4 d-none"
                            role="alert"></div>
                        <p class="text-center text-muted mt-4 mb-0 small">
                            Belum memiliki akun UPPS? <a href="#" class="text-decoration-none">silahkan daftar
                                disini</a>
                        </p>
                    </div>
                </div>
                <footer class="text-center mt-5 text-muted small">
                    <p>Copyright Â© 2025 LAM Teknik. All Rights Reserved</p>
                    <p class="mt-1">
                        <a href="#" class="text-decoration-none">Terms & Conditions</a> | <a href="#"
                            class="text-decoration-none">Privacy Policy</a>
                    </p>
                </footer>
            </div>
        </div>

        <div id="dashboard-container" class="login-card d-none">
            <div class="card shadow-sm border-light">
                <div class="card-body p-5 text-center">
                    <h2 class="h3 fw-bold">Selamat Datang!</h2>
                    <p id="userName" class="h5 text-primary mt-2"></p>
                    <div class="mt-4 bg-light p-3 rounded">
                        <p class="small text-muted mb-1">Peran Anda:</p>
                        <p id="userRole" class="fw-bold text-primary text-uppercase mb-0"></p>
                    </div>
                    <div class="mt-4">
                        <button id="logoutBtn" class="btn btn-secondary">Logout</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Menggunakan port 8801 untuk Fablo REST API Org1
        const API_BASE_URL = 'http://localhost:8801';
        const CHANNEL_NAME = 'my-channel1';
        const CHAINCODE_NAME = 'chaincode-submission-ts';

        const loginContainer = document.getElementById('login-container');
        const dashboardContainer = document.getElementById('dashboard-container');
        const loginForm = document.getElementById('loginForm');
        const loginBtn = document.getElementById('loginBtn');
        const loginBtnText = document.getElementById('loginBtnText');
        const loginLoader = document.getElementById('loginLoader');
        const loginResult = document.getElementById('loginResult');
        const logoutBtn = document.getElementById('logoutBtn');
        const userName = document.getElementById('userName');
        const userRole = document.getElementById('userRole');

        const errorIcon = `<i class="bi bi-exclamation-triangle-fill me-2"></i>`;

        loginForm.addEventListener('submit', handleLogin);
        logoutBtn.addEventListener('click', handleLogout);

        // Fungsi untuk mendapatkan token admin
        async function getAdminToken() {
            try {
                const response = await fetch(`${API_BASE_URL}/user/enroll`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        id: 'admin',
                        secret: 'adminpw'
                    })
                });

                if (!response.ok) {
                    throw new Error('Gagal mendapatkan token admin');
                }

                const data = await response.json();
                return data.token;
            } catch (error) {
                console.error('Error getting admin token:', error);
                throw error;
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const formData = new FormData(loginForm);
            const username = formData.get('username');
            const password = formData.get('password');
            const role = formData.get('role');

            console.log('Login attempt:', { username, role });
            setLoading(true);
            loginResult.classList.add('d-none');

            try {
                // Dapatkan token admin untuk autentikasi
                console.log('Getting admin token...');
                const token = await getAdminToken();
                console.log('Token received:', token);

                // Query user berdasarkan username menggunakan format API yang benar
                const url = `${API_BASE_URL}/query/${CHANNEL_NAME}/${CHAINCODE_NAME}`;
                const requestBody = {
                    method: 'UserContract:getUserByUsername',
                    args: [username]
                };

                console.log('Requesting URL:', url);
                console.log('Request body:', requestBody);

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(requestBody)
                });

                console.log('Response status:', response.status);
                console.log('Response headers:', [...response.headers.entries()]);

                if (!response.ok) {
                    const errorBody = await response.text();
                    console.error('API Error Response:', errorBody);

                    // Handle specific error cases
                    if (response.status === 400 && errorBody.includes('tidak ditemukan')) {
                        throw new Error('Username tidak ditemukan. Pastikan username sudah terdaftar di sistem.');
                    } else {
                        throw new Error(`Terjadi kesalahan server (${response.status}): ${errorBody}`);
                    }
                }

                const resultData = await response.json();
                console.log('Raw response:', resultData);

                // Parse response dari blockchain
                if (!resultData.response) {
                    throw new Error('Format response tidak valid dari server.');
                }

                const user = resultData.response;
                console.log('User data:', user);

                // Verify user credentials
                // UserContract menyimpan hashedPassword, jadi kita bandingkan langsung
                if (user && user.hashedPassword === password && user.role === role) {
                    console.log('Login successful');
                    showDashboard(user);
                } else if (!user) {
                    throw new Error('Data user tidak valid.');
                } else if (user.hashedPassword !== password) {
                    throw new Error('Password yang Anda masukkan salah.');
                } else if (user.role !== role) {
                    throw new Error(`Peran yang Anda pilih (${role}) tidak sesuai dengan akun Anda (${user.role}).`);
                } else {
                    throw new Error('Kredensial login tidak valid.');
                }
            } catch (error) {
                console.error('Error:', error);
                showError(error.message);
            } finally {
                setLoading(false);
            }
        }

        function handleLogout() {
            dashboardContainer.classList.add('d-none');
            loginContainer.classList.remove('d-none');
            loginForm.reset();
        }

        function showDashboard(user) {
            userName.textContent = user.username || user.userID;
            userRole.textContent = user.role;
            loginContainer.classList.add('d-none');
            dashboardContainer.classList.remove('d-none');
        }

        function setLoading(isLoading) {
            loginBtn.disabled = isLoading;
            loginBtnText.classList.toggle('d-none', isLoading);
            loginLoader.classList.toggle('d-none', !isLoading);
        }

        function showError(message) {
            loginResult.innerHTML = `${errorIcon}<div>${message}</div>`;
            loginResult.classList.remove('d-none');
        }
    </script>
</body>

</html>